<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Manajemen Pesanan</title>
    <!-- Kamu bisa gunakan CSS admin yang sudah ada atau buat baru -->
    <link rel="stylesheet" th:href="@{/css/adminorder.css}" /> 
    <style>
        .orders-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        .orders-table th, .orders-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .orders-table th { background-color: #f8f9fa; }
        .status-select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        .status-badge { padding: 5px 10px; border-radius: 12px; color: white; font-weight: bold; display: inline-block; }
        /* Pastikan nama kelas CSS sama dengan nilai status di database */
        .status-DIPROSES { background-color: #ffc107; color: black; }
        .status-DIKIRIM { background-color: #007bff; }
        .status-SELESAI { background-color: #28a745; }
        .status-DIBATALKAN { background-color: #dc3545; }
        #notification-bar { position: fixed; top: 0; left: 50%; transform: translateX(-50%); background-color: #28a745; color: white; padding: 15px; border-radius: 0 0 8px 8px; z-index: 1000; display: none; }
    </style>
</head>
<body>

<!-- Kamu bisa buat fragment untuk sidebar admin juga jika mau -->
<div class="sidebar">
    <h2>üéÇ Admin Panel</h2>
    <ul>
        <li><a href="/admin/dashboard">üè† Dashboard</a></li>
        <li><a href="/products">üç∞ Products</a></li>
        <li><a href="/admin/orders" class="active">üìã Orders</a></li>
        <li><a href="/admin/users">üë• Users</a></li>
        <li><a href="/login">üîô Logout</a></li>
    </ul>
</div>

<div class="main-content">
    <h1>Manajemen Pesanan</h1>
    <p>Ubah status pesanan langsung dari tabel di bawah ini.</p>
    
    <!-- Notifikasi Bar -->
    <div id="notification-bar"></div>

    <table class="orders-table">
        <thead>
            <tr>
                <th>ID Pesanan</th>
                <th>Nama Pelanggan</th>
                <th>Tanggal</th>
                <th>Total</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            <!-- Loop untuk setiap pesanan -->
            <tr th:each="order : ${orders}">
                <td th:text="'#' + ${order.id}">1</td>
                <td th:text="${order.user.nama}">Nama Pelanggan</td>
                <td th:text="${#temporals.format(order.orderDate, 'dd MMM yyyy, HH:mm')}">Tanggal</td>
                <td th:text="${#numbers.formatCurrency(order.totalAmount)}">Rp 0</td>
                <td>
                    <!-- =============================================== -->
                    <!-- PERBAIKAN: Logika untuk status final diperkuat -->
                    <!-- =============================================== -->
                    
                    <!-- JIKA status BUKAN 'SELESAI' DAN BUKAN 'DIBATALKAN', tampilkan dropdown -->
                    <div th:if="${order.status != 'SELESAI' and order.status != 'DIBATALKAN'}">
                        <select class="status-select" onchange="updateStatus(this, [[${order.id}]])">
                            <option value="DIPROSES" th:selected="${order.status == 'DIPROSES'}">Diproses</option>
                            <option value="DIKIRIM" th:selected="${order.status == 'DIKIRIM'}">Dikirim</option>
                            <option value="SELESAI" th:selected="${order.status == 'SELESAI'}">Selesai</option>
                            <option value="DIBATALKAN" th:selected="${order.status == 'DIBATALKAN'}">Dibatalkan</option>
                        </select>
                    </div>
                    
                    <!-- JIKA status SUDAH final, tampilkan sebagai teks biasa (badge) -->
                    <div th:if="${order.status == 'SELESAI' or order.status == 'DIBATALKAN'}">
                        <span class="status-badge" th:classappend="'status-' + ${order.status}" th:text="${order.status}"></span>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    function showNotification(message, isError = false) {
        const notifBar = document.getElementById('notification-bar');
        notifBar.textContent = message;
        notifBar.style.backgroundColor = isError ? '#dc3545' : '#28a745';
        notifBar.style.display = 'block';

        setTimeout(() => {
            notifBar.style.display = 'none';
        }, 3000); // Sembunyikan setelah 3 detik
    }

    function updateStatus(selectElement, transactionId) {
        const newStatus = selectElement.value;
        const data = { status: newStatus };

        fetch(`/admin/api/orders/${transactionId}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) return response.text().then(text => { throw new Error(text || 'Gagal update status') });
            return response;
        })
        .then(() => {
            showNotification(`Status pesanan #${transactionId} berhasil diubah menjadi ${newStatus}!`);
            

            if (newStatus === 'SELESAI' || newStatus === 'DIBATALKAN') {
                const parentDiv = selectElement.parentNode;
                // Buat badge baru dan ganti dropdown
                parentDiv.innerHTML = `<span class="status-badge status-${newStatus}">${newStatus}</span>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification(`Error: ${error.message}`, true);
        });
    }
</script>

</body>
</html>
